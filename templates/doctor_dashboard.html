{% extends "base.html" %}

{% block title %}Doctor Dashboard - Smart CKD Health Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 bg-light sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" onclick="showSection('overview')">
                            <i class="fas fa-tachometer-alt me-2"></i>Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#patients" onclick="showSection('patients')">
                            <i class="fas fa-users me-2"></i>Patients
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics" onclick="showSection('analytics')">
                            <i class="fas fa-chart-line me-2"></i>Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#predictions" onclick="showSection('predictions')">
                            <i class="fas fa-brain me-2"></i>Predictions
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content">
            <!-- Overview Section -->
            <div id="overview" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Doctor Dashboard</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-users fa-2x me-3"></i>
                                    <div>
                                        <h4 class="mb-0">{{ analytics.total_patients }}</h4>
                                        <small>Total Patients</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-heartbeat fa-2x me-3"></i>
                                    <div>
                                        <h4 class="mb-0">{{ analytics.ckd_patients }}</h4>
                                        <small>CKD Patients</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle fa-2x me-3"></i>
                                    <div>
                                        <h4 class="mb-0">{{ analytics.non_ckd_patients }}</h4>
                                        <small>Healthy Patients</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-chart-line fa-2x me-3"></i>
                                    <div>
                                        <h4 class="mb-0">{{ analytics.total_predictions }}</h4>
                                        <small>Total Predictions</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">CKD vs Non-CKD Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="ckdDistributionChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">CKD Stage Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="stageDistributionChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Performance -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Model Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h3 class="text-success">{{ (analytics.model_accuracy * 100)|round(1) }}%</h3>
                                        <small class="text-muted">Accuracy</small>
                                    </div>
                                    <div class="col-6">
                                        <h3 class="text-info">Random Forest</h3>
                                        <small class="text-muted">Algorithm</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Recent Activity</h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    {% for pred in analytics.recent_predictions[:3] %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Prediction {{ pred.prediction_id[:8] }}</strong>
                                            <br>
                                            <small class="text-muted">{{ pred.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        </div>
                                        <span class="badge bg-{{ 'danger' if pred.prediction_result.ckd_binary else 'success' }}">
                                            {{ 'CKD' if pred.prediction_result.ckd_binary else 'No CKD' }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patients Section -->
            <div id="patients" class="content-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Patient Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="loadPatients()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Patients
                        </button>
                    <button class="btn btn-outline-secondary" onclick="showSection('overview')">
                        <i class="fas fa-arrow-left me-2"></i>Back to Overview
                    </button>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Patient Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="patientSearch" placeholder="Name, email, or ID...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="genderFilter">
                                    <option value="">All</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">CKD Stage</label>
                                <select class="form-select" id="stageFilter">
                                    <option value="">All</option>
                                    <option value="No CKD">No CKD</option>
                                    <option value="Stage 1">Stage 1</option>
                                    <option value="Stage 2">Stage 2</option>
                                    <option value="Stage 3">Stage 3</option>
                                    <option value="Stage 4">Stage 4</option>
                                    <option value="Stage 5">Stage 5</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Risk Level</label>
                                <select class="form-select" id="riskFilter">
                                    <option value="">All</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="dateFrom" placeholder="From">
                                    <input type="date" class="form-control" id="dateTo" placeholder="To">
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-filter me-2"></i>Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                                    <i class="fas fa-times me-2"></i>Clear
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportPatients()">
                                    <i class="fas fa-download me-2"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">All Patients <span class="badge bg-primary" id="patientCount">0</span></h5>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end gap-2">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="loadPatients(currentPage - 1)" id="prevBtn" disabled>
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="btn btn-outline-secondary btn-sm" id="pageInfo">Page 1 of 1</span>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="loadPatients(currentPage + 1)" id="nextBtn" disabled>
                                            <i class="fas fa-chevron-right"></i>
                                    </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="patientsTable">
                                <thead>
                                    <tr>
                                        <th>Patient ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Age</th>
                                        <th>Gender</th>
                                        <th>Last Prediction</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- This will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="content-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Advanced Analytics</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Data
                        </button>
                        <button class="btn btn-success" onclick="downloadAnalytics()">
                            <i class="fas fa-download me-2"></i>Download CSV
                        </button>
                    <button class="btn btn-outline-secondary" onclick="showSection('overview')">
                        <i class="fas fa-arrow-left me-2"></i>Back to Overview
                    </button>
                    </div>
                </div>

                <!-- Analytics Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Analytics Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="analyticsDateFrom">
                                    <input type="date" class="form-control" id="analyticsDateTo">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CKD Stage</label>
                                <select class="form-select" id="analyticsStageFilter">
                                    <option value="">All Stages</option>
                                    <option value="No CKD">No CKD</option>
                                    <option value="Stage 1">Stage 1</option>
                                    <option value="Stage 2">Stage 2</option>
                                    <option value="Stage 3">Stage 3</option>
                                    <option value="Stage 4">Stage 4</option>
                                    <option value="Stage 5">Stage 5</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Risk Level</label>
                                <select class="form-select" id="analyticsRiskFilter">
                                    <option value="">All Risk Levels</option>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" onclick="applyAnalyticsFilters()">
                                        <i class="fas fa-filter me-2"></i>Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Prediction Trends</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="trendsChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Risk Level Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="riskLevelChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Confusion Matrix</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered text-center">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>Predicted No CKD</th>
                                                <th>Predicted CKD</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th>Actual No CKD</th>
                                                <td class="bg-success text-white" id="trueNegative">-</td>
                                                <td class="bg-danger text-white" id="falsePositive">-</td>
                                            </tr>
                                            <tr>
                                                <th>Actual CKD</th>
                                                <td class="bg-danger text-white" id="falseNegative">-</td>
                                                <td class="bg-success text-white" id="truePositive">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>Precision:</strong> <span id="precision">-</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Recall:</strong> <span id="recall">-</span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <strong>F1-Score:</strong> <span id="f1Score">-</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Accuracy:</strong> <span id="accuracy">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Detailed Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h4 class="text-primary" id="totalPatients">{{ analytics.total_patients }}</h4>
                                            <small class="text-muted">Total Patients</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h4 class="text-danger" id="ckdPatients">{{ analytics.ckd_patients }}</h4>
                                            <small class="text-muted">CKD Patients</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h4 class="text-success" id="nonCkdPatients">{{ analytics.non_ckd_patients }}</h4>
                                            <small class="text-muted">Healthy Patients</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-center">
                                            <h4 class="text-info" id="totalPredictions">{{ analytics.total_predictions }}</h4>
                                            <small class="text-muted">Total Predictions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Predictions Section -->
            <div id="predictions" class="content-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Recent Predictions</h2>
                    <button class="btn btn-outline-secondary" onclick="showSection('overview')">
                        <i class="fas fa-arrow-left me-2"></i>Back to Overview
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">All Predictions</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <select class="form-select" id="predictionFilter">
                                        <option value="">All Predictions</option>
                                        <option value="ckd">CKD Detected</option>
                                        <option value="no-ckd">No CKD</option>
                                        <option value="high-risk">High Risk</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient ID</th>
                                        <th>CKD Status</th>
                                        <th>Stage</th>
                                        <th>Confidence</th>
                                        <th>Risk Level</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pred in analytics.recent_predictions %}
                                    <tr>
                                        <td>{{ pred.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>{{ pred.patient_id }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if pred.prediction_result.ckd_binary else 'success' }}">
                                                {{ 'CKD Detected' if pred.prediction_result.ckd_binary else 'No CKD' }}
                                            </span>
                                        </td>
                                        <td>{{ pred.prediction_result.ckd_stage }}</td>
                                        <td>{{ (pred.prediction_result.confidence * 100)|round(1) if pred.prediction_result.confidence else 'N/A' }}%</td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if pred.prediction_result.risk_level == 'High' else 'warning' if pred.prediction_result.risk_level == 'Medium' else 'success' }}">
                                                {{ pred.prediction_result.risk_level }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="generateReport('{{ pred.prediction_id }}')">
                                                <i class="fas fa-file-pdf me-1"></i>Report
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Analytics data
const analyticsData = {{ analytics | tojson }};

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    document.getElementById(sectionId).style.display = 'block';
    
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Initialize charts when analytics or predictions section is shown
    if (sectionId === 'analytics' || sectionId === 'predictions') {
        loadAnalytics();
    }
}

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeOverviewCharts();
    loadPatients();
});

function initializeOverviewCharts() {
    // CKD Distribution Chart
    const ckdCtx = document.getElementById('ckdDistributionChart').getContext('2d');
    new Chart(ckdCtx, {
        type: 'doughnut',
        data: {
            labels: ['CKD Patients', 'Healthy Patients'],
            datasets: [{
                data: [analyticsData.ckd_patients, analyticsData.non_ckd_patients],
                backgroundColor: ['#dc3545', '#28a745'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Stage Distribution Chart
    const stageCtx = document.getElementById('stageDistributionChart').getContext('2d');
    const stageData = analyticsData.stage_distribution;
    new Chart(stageCtx, {
        type: 'bar',
        data: {
            labels: Object.keys(stageData),
            datasets: [{
                label: 'Number of Patients',
                data: Object.values(stageData),
                backgroundColor: [
                    '#28a745', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1', '#20c997'
                ],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeAnalyticsCharts() {
    // Trends Chart
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'CKD Predictions',
                data: [12, 19, 15, 25],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }, {
                label: 'Healthy Predictions',
                data: [8, 12, 10, 18],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Risk Level Chart
    const riskCtx = document.getElementById('riskLevelChart').getContext('2d');
    new Chart(riskCtx, {
        type: 'pie',
        data: {
            labels: ['High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
                data: [15, 25, 10],
                backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

let currentPage = 1;
let currentFilters = {};

async function loadPatients(page = 1) {
    try {
        currentPage = page;
        
        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            page_size: 10,
            ...currentFilters
        });
        
        const response = await fetch(`/api/patients?${params}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Patients API response:', data);
        const patientsTable = document.querySelector('#patientsTable tbody');
        
        if (data.success && data.patients) {
            patientsTable.innerHTML = '';
            
            data.patients.forEach(patient => {
                const row = document.createElement('tr');
                
                // Determine badge class based on health status
                let badgeClass = 'bg-secondary';
                if (patient.health_status === 'Healthy') {
                    badgeClass = 'bg-success';
                } else if (patient.health_status.includes('CKD')) {
                    badgeClass = 'bg-danger';
                }
                
                // Risk level badge
                let riskBadge = '';
                if (patient.risk_level) {
                    let riskClass = 'bg-success';
                    if (patient.risk_level === 'High') riskClass = 'bg-danger';
                    else if (patient.risk_level === 'Medium') riskClass = 'bg-warning';
                    riskBadge = `<span class="badge ${riskClass} ms-1">${patient.risk_level}</span>`;
                }
                
                row.innerHTML = `
                    <td>${patient.patient_id}</td>
                    <td>${patient.name}</td>
                    <td>${patient.email}</td>
                    <td>${patient.age || 'N/A'}</td>
                    <td>${patient.gender || 'N/A'}</td>
                    <td>${patient.created_at}</td>
                    <td>
                        <span class="badge ${badgeClass}">${patient.health_status}</span>
                        ${riskBadge}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPatient('${patient.patient_id}')" title="View details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="sendMessageToPatient('${patient.patient_id}')" title="Send message">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                patientsTable.appendChild(row);
            });
            
            // Update pagination
            updatePagination(data.pagination);
            document.getElementById('patientCount').textContent = data.pagination.total_count;
            
            console.log(`Loaded ${data.patients.length} of ${data.pagination.total_count} patients`);
        } else {
            patientsTable.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">No patients found</td>
                </tr>
            `;
            updatePagination({page: 1, total_pages: 1, has_prev: false, has_next: false});
        }
    } catch (error) {
        console.error('Error loading patients:', error);
        const patientsTable = document.querySelector('#patientsTable tbody');
        patientsTable.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger">Error loading patients: ${error.message}</td>
            </tr>
        `;
    }
}

function updatePagination(pagination) {
    document.getElementById('pageInfo').textContent = `Page ${pagination.page} of ${pagination.total_pages}`;
    document.getElementById('prevBtn').disabled = !pagination.has_prev;
    document.getElementById('nextBtn').disabled = !pagination.has_next;
}

function applyFilters() {
    currentFilters = {
        search: document.getElementById('patientSearch').value,
        gender: document.getElementById('genderFilter').value,
        stage: document.getElementById('stageFilter').value,
        risk: document.getElementById('riskFilter').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value
    };
    
    // Remove empty filters
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) {
            delete currentFilters[key];
        }
    });
    
    loadPatients(1);
}

function clearFilters() {
    document.getElementById('patientSearch').value = '';
    document.getElementById('genderFilter').value = '';
    document.getElementById('stageFilter').value = '';
    document.getElementById('riskFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    currentFilters = {};
    loadPatients(1);
}

function exportPatients() {
    const params = new URLSearchParams({
        ...currentFilters,
        export: 'true'
    });
    
    window.open(`/api/patients/export?${params}`, '_blank');
}

// Analytics functions
function applyAnalyticsFilters() {
    const filters = {
        date_from: document.getElementById('analyticsDateFrom').value,
        date_to: document.getElementById('analyticsDateTo').value,
        stage: document.getElementById('analyticsStageFilter').value,
        risk: document.getElementById('analyticsRiskFilter').value
    };
    
    // Remove empty filters
    Object.keys(filters).forEach(key => {
        if (!filters[key]) {
            delete filters[key];
        }
    });
    
    loadAnalytics(filters);
}

function loadAnalytics(filters = {}) {
    const params = new URLSearchParams(filters);
    
    fetch(`/api/analytics?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Analytics data:', data);
            updateAnalyticsCharts(data);
            updateConfusionMatrix(data.confusion_matrix);
            updatePerformanceMetrics(data);
        })
        .catch(error => console.error('Error loading analytics:', error));
}

function updateConfusionMatrix(matrix) {
    console.log('Updating confusion matrix:', matrix);
    if (matrix) {
        document.getElementById('trueNegative').textContent = matrix.true_negative || 0;
        document.getElementById('falsePositive').textContent = matrix.false_positive || 0;
        document.getElementById('falseNegative').textContent = matrix.false_negative || 0;
        document.getElementById('truePositive').textContent = matrix.true_positive || 0;
    }
}

function updatePerformanceMetrics(data) {
    console.log('Updating performance metrics:', data);
    if (data) {
        document.getElementById('precision').textContent = (data.precision * 100).toFixed(1) + '%';
        document.getElementById('recall').textContent = (data.recall * 100).toFixed(1) + '%';
        document.getElementById('f1Score').textContent = (data.f1_score * 100).toFixed(1) + '%';
        document.getElementById('accuracy').textContent = (data.model_accuracy * 100).toFixed(1) + '%';
    }
}

function downloadAnalytics() {
    const filters = {
        date_from: document.getElementById('analyticsDateFrom').value,
        date_to: document.getElementById('analyticsDateTo').value,
        stage: document.getElementById('analyticsStageFilter').value,
        risk: document.getElementById('analyticsRiskFilter').value
    };
    
    const params = new URLSearchParams(filters);
    window.open(`/api/analytics/export?${params}`, '_blank');
}

function refreshAnalytics() {
    loadAnalytics();
}

// Messaging functions
function sendMessageToPatient(patientId) {
    const message = prompt('Enter message for patient:');
    if (message && message.trim()) {
        fetch('/api/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                patient_id: patientId,
                content: message.trim()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message sent successfully!');
            } else {
                alert('Error sending message: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Error sending message');
        });
    }
}

async function viewPatient(patientId) {
    try {
        const response = await fetch(`/api/patient/${patientId}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin'
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Failed to load patient');
        }

        // Build simple modal dynamically (no dependency on Bootstrap JS)
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1050;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
            <div class="card" style="width: 720px; max-width: 95vw;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Patient Details</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="patientModalClose">&times;</button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>ID:</strong> ${data.patient.patient_id}<br>
                            <strong>Name:</strong> ${data.patient.personal_info.name}<br>
                            <strong>Email:</strong> ${data.patient.personal_info.email}<br>
                            <strong>Phone:</strong> ${data.patient.personal_info.phone || 'N/A'}
                        </div>
                        <div class="col-md-6">
                            <strong>Age:</strong> ${data.patient.personal_info.age || 'N/A'}<br>
                            <strong>Gender:</strong> ${data.patient.personal_info.gender || 'N/A'}<br>
                            <strong>Joined:</strong> ${data.patient.created_at || 'N/A'}
                        </div>
                    </div>
                    <h6 class="mb-2">Recent Predictions</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>CKD Status</th>
                                    <th>Stage</th>
                                    <th>Confidence</th>
                                    <th>Risk</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recent_predictions.map(p => `
                                    <tr>
                                        <td>${p.created_at}</td>
                                        <td>
                                            <span class="badge ${p.ckd_binary ? 'bg-danger' : 'bg-success'}">${p.ckd_binary ? 'CKD' : 'No CKD'}</span>
                </td>
                                        <td>${p.ckd_stage || '-'}</td>
                                        <td>${p.confidence ? (p.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                                        <td>
                                            <span class="badge ${p.risk_level === 'High' ? 'bg-danger' : p.risk_level === 'Medium' ? 'bg-warning' : 'bg-success'}">${p.risk_level}</span>
                </td>
            </tr>
                                `).join('')}
                                ${data.recent_predictions.length === 0 ? '<tr><td colspan="5" class="text-muted text-center">No predictions</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <input type="text" id="doctorMsgInput" class="form-control" placeholder="Type instruction (e.g., medicine)" style="max-width: 400px;">
                        <button class="btn btn-primary" id="doctorMsgSend">Send</button>
                        <button class="btn btn-secondary" id="patientModalClose2">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        const close = () => modal.remove();
        modal.querySelector('#patientModalClose').addEventListener('click', close);
        modal.querySelector('#patientModalClose2').addEventListener('click', close);
        modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

        // Send instruction message
        modal.querySelector('#doctorMsgSend').addEventListener('click', async () => {
            const input = modal.querySelector('#doctorMsgInput');
            const content = (input.value || '').trim();
            if (!content) return;
            try {
                const resp = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ patient_id: data.patient.patient_id, content })
                });
                const js = await resp.json();
                if (!resp.ok || !js.success) throw new Error(js.error || `HTTP ${resp.status}`);
                input.value = '';
                alert('Instruction sent to patient');
            } catch (err) {
                alert('Failed to send: ' + err.message);
            }
        });
    } catch (error) {
        console.error('Error viewing patient:', error);
        alert('Error loading patient details: ' + error.message);
    }
}

function refreshAnalytics() {
    location.reload();
}

function generateReport(predictionId) {
    console.log('Generating report for:', predictionId);
    
    // Use direct download endpoint
    const downloadUrl = `/api/download-report/${predictionId}?t=${Date.now()}`;
    
    // Create a temporary link element for download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `ckd_report_${predictionId}.pdf`;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // Trigger download
    link.click();
    
    // Clean up
    setTimeout(() => {
        document.body.removeChild(link);
    }, 100);
    
    console.log('Download initiated');
}

// Load analytics when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
});
</script>
{% endblock %}
